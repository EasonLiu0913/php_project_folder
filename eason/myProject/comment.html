<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>INSPINIA | Profile</title>

    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet" />
    <link href="css/animate.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div id="wrapper">
      <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
          <ul class="nav metismenu" id="side-menu">
            <li class="nav-header">
              <div class="dropdown profile-element">
                <img
                  alt="image"
                  class="rounded-circle"
                  src="img/profile_small.jpg"
                />
                <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                  <span class="block m-t-xs font-bold">Chris Wang</span>
                  <span class="text-muted text-xs block">Product Manager</span>
                </a>
                <ul class="dropdown-menu animated fadeInRight m-t-xs">
                  <li>
                    <a class="dropdown-item" href="#">Profile</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">Contacts</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">Mailbox</a>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#">Logout</a></li>
                </ul>
              </div>
              <div class="logo-element">
                T+3C
              </div>
            </li>
            <li class="active">
              <a href="#"
                ><i class="fa fa-th-large"></i>
                <span class="nav-label">商品評論</span>
                </a>
            </li>
          </ul>
        </div>
      </nav>

      <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
          <nav
            class="navbar navbar-static-top"
            role="navigation"
            style="margin-bottom: 0"
          >
            <div class="navbar-header">
              <a
                class="navbar-minimalize minimalize-styl-2 btn btn-primary "
                href="#"
                ><i class="fa fa-bars"></i>
              </a>
              <form
                role="search"
                class="navbar-form-custom"
                action="#"
              >
                <div class="form-group">
                  <input
                    type="text"
                    placeholder="Search for something..."
                    class="form-control"
                    name="top-search"
                    id="top-search"
                  />
                </div>
              </form>
            </div>
            <ul class="nav navbar-top-links navbar-right">
              <li>
                <span class="m-r-sm text-muted welcome-message"
                  >Welcome to Traveler3C Admin Page.</span
                >
              </li>
              <li class="dropdown">
                <a
                  class="dropdown-toggle count-info"
                  data-toggle="dropdown"
                  href="#"
                >
                  <i class="fa fa-envelope"></i>
                  <span class="label label-warning">16</span>
                </a>
                <ul class="dropdown-menu dropdown-messages">
                  <li>
                    <div class="dropdown-messages-box">
                      <a class="dropdown-item float-left" href="#">
                        <img
                          alt="image"
                          class="rounded-circle"
                          src="img/a7.jpg"
                        />
                      </a>
                      <div class="media-body">
                        <small class="float-right">46h ago</small>
                        <strong>Mike Loreipsum</strong> started following
                        <strong>Monica Smith</strong>. <br />
                        <small class="text-muted"
                          >3 days ago at 7:58 pm - 10.06.2014</small
                        >
                      </div>
                    </div>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <div class="dropdown-messages-box">
                      <a class="dropdown-item float-left" href="#">
                        <img
                          alt="image"
                          class="rounded-circle"
                          src="img/a4.jpg"
                        />
                      </a>
                      <div class="media-body ">
                        <small class="float-right text-navy">5h ago</small>
                        <strong>Chris Johnatan Overtunk</strong> started
                        following <strong>Monica Smith</strong>. <br />
                        <small class="text-muted"
                          >Yesterday 1:21 pm - 11.06.2014</small
                        >
                      </div>
                    </div>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <div class="dropdown-messages-box">
                      <a class="dropdown-item float-left" href="#">
                        <img
                          alt="image"
                          class="rounded-circle"
                          src="img/profile.jpg"
                        />
                      </a>
                      <div class="media-body ">
                        <small class="float-right">23h ago</small>
                        <strong>Monica Smith</strong> love
                        <strong>Kim Smith</strong>. <br />
                        <small class="text-muted"
                          >2 days ago at 2:30 am - 11.06.2014</small
                        >
                      </div>
                    </div>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <div class="text-center link-block">
                      <a href="#" class="dropdown-item">
                        <i class="fa fa-envelope"></i>
                        <strong>Read All Messages</strong>
                      </a>
                    </div>
                  </li>
                </ul>
              </li>
              <li class="dropdown">
                <a
                  class="dropdown-toggle count-info"
                  data-toggle="dropdown"
                  href="#"
                >
                  <i class="fa fa-bell"></i>
                  <span class="label label-primary">8</span>
                </a>
                <ul class="dropdown-menu dropdown-alerts">
                  <li>
                    <a href="#" class="dropdown-item">
                      <div>
                        <i class="fa fa-envelope fa-fw"></i> You have 16
                        messages
                        <span class="float-right text-muted small"
                          >4 minutes ago</span
                        >
                      </div>
                    </a>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item">
                      <div>
                        <i class="fa fa-twitter fa-fw"></i> 3 New Followers
                        <span class="float-right text-muted small"
                          >12 minutes ago</span
                        >
                      </div>
                    </a>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item">
                      <div>
                        <i class="fa fa-upload fa-fw"></i> Server Rebooted
                        <span class="float-right text-muted small"
                          >4 minutes ago</span
                        >
                      </div>
                    </a>
                  </li>
                  <li class="dropdown-divider"></li>
                  <li>
                    <div class="text-center link-block">
                      <a href="#" class="dropdown-item">
                        <strong>See All Alerts</strong>
                        <i class="fa fa-angle-right"></i>
                      </a>
                    </div>
                  </li>
                </ul>
              </li>

              <li>
                <a href="#">
                  <i class="fa fa-sign-out"></i> Log out
                </a>
              </li>
            </ul>
          </nav>
        </div>
        <div class="row wrapper border-bottom white-bg page-heading">
          <div class="col-lg-10">
            <h2>商品評論</h2>
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="#">Home</a>
              </li>
              <li class="breadcrumb-item">
                <a>商品管理</a>
              </li>
              <li class="breadcrumb-item active">
                <strong>商品評論</strong>
              </li>
            </ol>
          </div>
          <div class="col-lg-2"></div>
        </div>
        <div class="wrapper wrapper-content">
          <div class="row animated fadeInRight">
            <div class="col-md-4">
              <div class="ibox ">
                  <div class="ibox-title">
                    <!-- 左側的商品列表，預計未來改從資料庫讀取 -->
                      <h5>商品列表</h5>
                  </div>
                  <div>
                      <div class="ibox-content no-padding border-left-right">
                      </div>
                      <div class="ibox-content profile-content">
                          <p><strong><a id="pt001" href="#">DTA-Watch智能手錶</a>   </strong></p>
                          <p><strong><a id="pt002" href="#">Vivoactive 4 / 4s VENU GPS智慧腕錶</a> </strong></p>
                          <p><strong><a id="pt003" href="#">Forerunner 45 FR45 /45s</a> </strong></p>
                          <p><strong><a id="pt004" href="#">Forerunner 245 M 音樂跑錶</a> </strong></p>
                      </div>
              </div>
          </div>
              </div>

            <div class="col-md-8">
              <div class="ibox">
                <div class="ibox-title">
                  <h5 id="product-comment-title">商品評論</h5>
                  <div class="ibox-tools">
                    <a class="collapse-link">
                      <i class="fa fa-chevron-up"></i>
                    </a>
                    
                  </div>
                </div>
                <div class="ibox-content">
                  <div>
                    <div class="feed-activity-list">
                      <!-- 評論模版預計放這裡 -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div><strong>Copyright</strong> Traveler3C Company &copy; 2020</div>
        </div>
      </div>
    </div>

    <!-- Mainly scripts -->
    <script src="js/jquery-3.1.1.min.js"></script>
    <script>

    let commentArea = document.querySelector('.feed-activity-list');
    let CommentTitle = document.querySelector('#product-comment-title');
    let nowReplyId = '';
    let url = window.location.href; 
    let productId = '';

    //判斷網址是否有帶 "?"
    if (url.indexOf('?') !== -1){
      productId = (url.split("?")[1]).split("=")[1];
      getComment((url.split("?")[1]).split("=")[1]);
    }

    //判斷超連結點擊 
    $(document).on('click','a',function(e){
      e.preventDefault();

      //判斷點擊商品列表
      if (e.currentTarget.id.substring(0,2) === 'pt'){
        productId = e.currentTarget.id;
        CommentTitle.innerHTML = "商品評論: "+e.target.textContent;
        getComment(e.currentTarget.id);
      }

      //判斷點擊回覆留言
      else if (e.currentTarget.id.substring(0,6) === 'reply_'){

        //判斷如果 nowReplyId 跟 點擊id 不同
        if (nowReplyId !== e.currentTarget.id){

          //nowReplyId 為空值，表示是第一次點擊回覆留言
          if(nowReplyId === ''){
            let commentId = e.currentTarget.id.replace('reply_','');
            let lasttimeComment = '';
            
            // console.log();
            //判斷按鈕文字為： 回覆留言 或 修改留言
            if ($('#'+e.currentTarget.id)[0].innerText ==='回覆留言'){
              $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">取消回覆</button>');
            }
            else{
              $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">取消修改</button>');
              lasttimeComment = $('#'+e.currentTarget.id).parent().prev().html();
            }

            let replayHtml = `<form action="./sendReply.php" method="POST">
            <textarea name="replyText" cols="50" rows="5">${lasttimeComment}</textarea> <input type="submit" value="送出"><input type="hidden" name="commentId" value="${commentId}"><input type="hidden" name="prodoctId" value="${productId}"></form>`;
            
            //在點擊處新增回覆留言的 html 
            $('#'+e.currentTarget.id).parent().append(replayHtml);
            //設置目前回覆留言id
            nowReplyId = e.currentTarget.id;
          }

          //nowReplyId 不是空值，表示是第二次點擊回覆留言
          else{
            
            //先刪除上一次點擊回覆留言處的 html 
            $('#'+nowReplyId).siblings().remove(); 

            //判斷上一次點擊的按鈕文字，並還原文字： 回覆留言 或 修改留言
            if ($('#'+nowReplyId)[0].innerText ==='取消回覆'){
                $('#'+nowReplyId).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">回覆留言</button>');
              }
              else{
                $('#'+nowReplyId).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">修改留言</button>');
              }

            //取得回覆留言id
            let commentId = e.currentTarget.id.replace('reply_','');

            //設置回覆留言html
            let replayHtml = `<form action="./sendReply.php" method="POST">
              <textarea name="replyText" cols="50" rows="5"></textarea> <input type="submit" value="送出"><input type="hidden" name="commentId" value="${commentId}"></form>`;

            //判斷回覆留言或修改留言
            if (e.currentTarget.textContent.trim() ==='回覆留言'){
              $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">取消回覆</button>');
            }
            else{
              $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">取消修改</button>');
            }
            
            //在新點擊回覆留言處新增回覆留言的 html
            $('#'+e.currentTarget.id).parent().append(replayHtml);
            //更新nowReplyId
            nowReplyId = e.currentTarget.id;
          }
        } 

        //判斷 nowReplyId === 點擊id，表示使用者想取消回覆留言功能，執行 else 裡的程式碼
        else{
          
          //先將留言回覆區 HTML 去掉
          $('#'+e.currentTarget.id).siblings().remove();

          //判斷原本按鈕文字，並重置成 回覆留言 或 修改留言
          if ($('#'+e.currentTarget.id)[0].innerText ==='取消回覆'){
                $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">回覆留言</button>');
              }
              else{
                $('#'+e.currentTarget.id).html('<button class="btn btn-default btn-block" style="margin-bottom:20px;">修改留言</button>');
              }

          //重置 nowReplyId 
          nowReplyId='';
        }
      }
    });

    //使用 ajax 取得商品評論
    function getComment(productId){
      $.ajax({ 
        url:'./readComment.php', 
        type:'post', 
        data:{'productId': productId}, 
        async : true, //預設為true 非同步 
        // error:function(){ 
        //   alert('error'); 
        // }, 
        success:function(data){ 

          commentArea.innerHTML = '';
          if(data == ''){
            commentArea.innerHTML = '此商品尚無任何評論';
          }
          else{
            let arrayData = JSON.parse(data);
            for (let i=0; i< arrayData.length; i++){
            let photoHtml = (arrayData[i].img)?`<div class="photos">
                            <img
                              alt="image"
                              class="feed-photo"
                              src="${arrayData[i].img}"
                            />
                          </div>`:'';

            let replyText = (arrayData[i].replyText)?`<BR><small style="margin-top:10px">我的回覆：</small><div class="well">${arrayData[i].replyText}</div>`:'';
            let replyButtonText = (arrayData[i].replyText)?'修改留言':'回覆留言';

            //設定評價星數
            let rankStar = '';
            if (arrayData[i].rank != 0){
              //最多跑5次迴圈
              for(let k=0; k< 5; k++){
                //如果評價數字 >= i+1，則畫一個黑色的星星
                console.log(arrayData[i].rank);
                console.log(k+1);
                if ( arrayData[i].rank >= k+1){
                  rankStar += `<div class="shopee-rating-stars__lit" style="width: 15px;fill:#FF2D2D;"><svg class="shopee-svg-icon shopee-rating-stars__primary-star icon-rating-solid" enable-background="new 0 0 15 15" viewBox="0 0 15 15" x="0" y="0"><polygon points="7.5 .8 9.7 5.4 14.5 5.9 10.7 9.1 11.8 14.2 7.5 11.6 3.2 14.2 4.3 9.1 .5 5.9 5.3 5.4" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10"></polygon></svg></div>`;
                }
                //如果評價數字 < i+1，則畫一個灰色的星星
                else{
                  rankStar += `<div class="shopee-rating-stars__lit" style="width: 15px;fill:#FFB5B5;"><svg class="shopee-svg-icon shopee-rating-stars__primary-star icon-rating-solid" enable-background="new 0 0 15 15" viewBox="0 0 15 15" x="0" y="0"><polygon points="7.5 .8 9.7 5.4 14.5 5.9 10.7 9.1 11.8 14.2 7.5 11.6 3.2 14.2 4.3 9.1 .5 5.9 5.3 5.4" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10"></polygon></svg></div>`;
                }
              }
            }
            let template = `<div class="feed-element">
                        <a href="#" class="float-left">
                          <img
                            alt="image"
                            class="rounded-circle"
                            src="./img/a${arrayData[i].userId}.jpg"
                          />
                        </a>
                        <div class="media-body ">
                          <small class="float-right">${arrayData[i].updated_at}</small>
                          <strong>${arrayData[i].userName}</strong> 評價了您的商品： <br />
                          <div class="d-flex">
                          ${rankStar}
                          </div>
                          ${photoHtml}
                          <div>
                          <h3>${arrayData[i].commentText}</h3>
                        </div>
                          ${replyText}
                            
                        <div class="float-right">
                            <a id="reply_${arrayData[i].commentId}" href="#">
                              <button class="btn btn-default btn-block" style="margin-bottom:20px;">
                                ${replyButtonText}
                              </button>
                            </a>
                        </div>
                        </div>
                        
                      </div>`;
                      commentArea.innerHTML += (template);
          }
          }
        }
      });
    }
      
    </script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>

    <!-- Peity -->
    <script src="js/plugins/peity/jquery.peity.min.js"></script>

    <!-- Peity -->
    <script src="js/demo/peity-demo.js"></script>

    
  </body>
</html>
